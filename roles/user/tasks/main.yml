---
- name: Create a login user
  user:
    name: "{{ user }}"
    group: wheel
    append: yes
    createhome: yes # Defaults to yes
    home: /home/ansible # Defaults to /home/<username>
    state: present
    generate_ssh_key: yes
    ssh_key_type: rsa
    ssh_key_file: "~/.ssh/id_rsa.pub"

- name: Add public key to authorized_keys
  authorized_key:
    user: "{{ user }}"
    state: present
    key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

#  - name: User Creation Playbook - Add {{ user }} to sudoers file
#    ansible.builtin.lineinfile:
#      path: /etc/sudoers
#      state: present
#      regexp: '^{{ user }}'
#      line: '{{ user }} ALL=(ALL) NOPASSWD: ALL'
#      validate: 'visudo -cf %s'

- name: adding existing user "{{ user }}" to group docker
  user:
    name: "{{ user }}"
    groups: docker
    append: yes
  become: yes

- name: Add user "{{ user }}" to sudo
  become: yes
  lineinfile:
    path: /etc/sudoers.d/"{{ user }}"
    line: '"{{ user }}" ALL=(ALL:ALL) NOPASSWD: ALL'
    state: present
    mode: 0440
    create: yes
 #   validate: 'visudo -cf /etc/sudoers.d/"{{ user }}"'
    validate: 'visudo -cf %s'

